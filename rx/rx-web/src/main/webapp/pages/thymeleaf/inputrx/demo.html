<!DOCTYPE html>
<!--
	作者：Hz
	时间：2018-01-10
	
	描述：点击链接发送POST请求后并打开一个新窗口
	
	此DEMO采用JQuery发送的ajax请求。
	
	测试环境：firefox,chrome,360浏览器,IE8
-->
<html>

<head>
<meta charset="UTF-8">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<title></title>
</head>


<!--   引入jquery 根据情况引入相应版本即可。    -->
<div th:include="/thymeleaf/common/head3::headx('处方录入')"	th:remove="tag"></div>
<!-- <script th:src="@{/static/jquery/1.11.3/jquery-1.11.3.js}"></script> -->
<script type="@{/static/js/json2/json2.js}"></script>

<body>
	<!-- 用于发起第一次请求：发送医、患数据 -->
	<div>
		<a href="javascript:void(0);" class="a_post" method="post">发起POST请求并打开新窗口</a>
	</div>

	<div>
		<a href='' id="get-test-1" method="get">发起GET请求返回JSON数据包:测试用例1</a>  </br>
		<a href='' id="get-test-2" method="get">发起GET请求返回JSON数据包:测试用例2</a>  </br>
		<a href='' id="get-test-3" method="get">发起GET请求返回JSON数据包:测试用例3</a>  </br>
		<a href='' id="get-test-4" method="get">发起GET请求返回JSON数据包:测试用例4</a>  </br>
		
	</div>
</body>

<script>
	/*********************************************			
		功能描述：打开非医保处方录入窗口
		
		注1：第二次发送请求，发送患者ID，并打开窗口
		注2：在弹窗时，浏览器会阻止弹窗。
			 可在浏览器中设置允许弹窗的链接。
	 *********************************************/
	function open_win(patientId) {
		//url2的实际地址由【非医保Rx】给出。在原有需求文档中，并没有此地址信息，需要加入。
		//patientId为当前患者的ID，需要根据实际情况替换相应的值。

		url2 = BASE_CONTEXT_PATH+"/openwin?patientId=" + patientId;
		window.open(url2, "_blank");

	}

	/**
		设置get请求的  URL,由于参数中有汉字,需要进行url编码处理
	 */
	function setGetUrl() {
		
		/* var url = BASE_CONTEXT_PATH+"/api?"
				+ "patientid=123&patientrn=123456789&patientname=张三&patientgender=男&patientold=50&patientcrno=123456&doctorid=12&doctorname=李四&departmentid=15&departmentname=内科&diagnosisresult=消化不良,重感冒"; */
		var url1=BASE_CONTEXT_PATH+"/api";  //test case 1
		var url2=BASE_CONTEXT_PATH+"/api?patientid=123";  //test case 2
		var url3=BASE_CONTEXT_PATH+"/api?patientrn=123456789&patientname=张三";  //test case 3
		var url4=BASE_CONTEXT_PATH+"/api?patientid=123&patientrn=123456789&patientname=张三&patientgender=男&patientold=50&patientcrno=123456&doctorid=12&doctorname=李四&departmentid=15&departmentname=内科&diagnosisresult=消化不良,重感冒";  //test case 4
		

		$("#get-test-1").attr("href", encodeURI(url1));
		$("#get-test-2").attr("href", encodeURI(url2));
		$("#get-test-3").attr("href", encodeURI(url3));
		$("#get-test-4").attr("href", encodeURI(url4));
	}

	$(function() {

		//设置get链接的url
		setGetUrl();

		/*******************************
			功能描述：绑定链接的click事件
				 AJAX方式发送POST请求。
		 ******************************/
		$(".a_post").on("click", function(event) {

			//alert("click");
			//传递医、患等信息的URL，由【非医保Rx】提供，此处仅为测试URL
			url1 = BASE_CONTEXT_PATH+"/api";

			// 传递的参数 此处仅为示例数据，实际数据按协议	
			// 模拟生成医,患,诊断信息		

			event.preventDefault(); //使a自带的方法失效，即无法调整到href中的URL		

			//采用AJAX方式发送POST请求
			$.ajax({
				type : "POST",
				url : url1,
				//contentType: "application/json", //指定发送到服务器时参数的格式				
				dataType : "json", //指定自服务器接收到的数据格式
				data : {
					patientid : "2345",
					patientrn : "djh123456789",
					patientname : "张三",
					patientgender : "男",
					patientold : "50",
					patientcrno : "blh12345",
					doctorid : "12",
					doctorname : "李四",
					departmentid : "15",
					departmentname : "内科",
					diagnosisresult : "消化不良,重感冒"

				}, //传递的参数				

				success : function(result) {
					//请求正确之后的操作
					// console.log(result);
					//alert(result.patientId);
					var patientId = result.patientId;
					open_win(patientId);
				},
				error : function(result) {
					//请求失败之后的操作
					//显示提示信息					
					//console.log(result);
					//open_win();
				}
			});

		});

		/**************************
			此方法暂时没有使用.
			功能描述：绑定链接的click事件
				 AJAX方式发送POST请求。
		 **************************/
		$(".a_post_test").on("click", function(event) {

			//传递医、患等信息的URL，由【非医保Rx】提供，此处仅为测试URL
			url1 = "http://localhost:8080/rx-web/api";

			// 传递的参数 此处仅为示例数据，实际数据按协议	
			// 模拟生成医,患,诊断信息		

			// 生成参数对象
			parms = new Object();
			parms.version = "1.0";
			parms.token = "DHHIS";
			parms.func = "patient_nmi";
			parms.data = {
				"patient" : {
					"id" : "01",
					"name" : "张三",
					"gender" : "男",
					"old" : "75",
					"cr_no" : "123456789"
				},
				"doctor" : {
					"id" : "02",
					"name" : "李四"
				},
				"department" : {
					"id" : "03",
					"name" : "内科"
				},
				"diagnosis" : [ {
					"id" : "001",
					"disease" : "慢性胃炎"
				}, {
					"id" : "002",
					"disease" : "营养不良"
				} ]
			};

			event.preventDefault(); //使a自带的方法失效，即无法调整到href中的URL		

			//采用AJAX方式发送POST请求
			$.ajax({
				type : "POST",
				url : url1,
				contentType : "application/json", //指定发送到服务器时参数的格式				
				dataType : "json", //指定自服务器接收到的数据格式
				data : JSON.stringify(parms), //传递的参数,JSON格式。				

				success : function(result) {
					//请求正确之后的操作
					// console.log(result);
					open_win();
				},
				error : function(result) {
					//请求失败之后的操作
					//显示提示信息					
					//console.log(result);
					//open_win();
				}
			});

		});

	});
</script>



</html>